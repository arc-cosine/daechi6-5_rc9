<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>자리 경매 시스템</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background: #f6faff;
        }

        .seat-grid {
            display: grid;
            grid-template-columns: repeat(6, 100px);
            grid-gap: 10px;
            margin-bottom: 20px;
            position: relative;
        }

        .seat {
            background: #d5f0ff;
            border: 1px solid #bbb;
            border-radius: 4px;
            padding: 5px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 60px;
            transition: background 0.3s;
        }

        .seat input {
            border: none;
            background: transparent;
            text-align: center;
            font-size: 12px;
            padding: 2px;
            margin: 1px 0;
        }

        .seat input:focus {
            outline: none;
            background: #fff8cc;
        }

        .seat.flagged {
            background: #ffcccc;
        }

        .last-seat {
            position: absolute;
            width : 100px;
            top: 0px;  /* 70*4 + 여유 */
            left: 660px; /* 100*6 + 여유 */
        }

        /*#applyBtn, #printBtn {*/
        button {
            padding: 10px 20px;
            background: #5fcf80;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }

        #output {
            white-space: pre;
            margin-top: 20px;
            background: #eee;
            padding: 10px;
            font-family: monospace;
            width: 90%;
            height: 200px;
        }
        @media print {
            body {
                margin: 0;
                padding: 0;
            }
            h2 {
                display: none !important;
            }
        #output, #applyBtn, #printBtn, #saveBtn{
        display: none;
        }
        .seat-grid {
            width : 100%;
        }
        }
    </style>
</head>
<body>
<h2>자리 경매</h2>

<div class="seat-grid" id="seatGrid"></div>

<div style="text-align: center;">
<!--    <button id="applyBtn">적용</button>-->
    <button id="printBtn">인쇄</button>
    <button id="saveBtn" style="margin-left: 10px; background:#444;">JSON 저장</button>
<!--    <button id="loadBtn">기존 자리 불러오기</button>-->
</div>

<textarea id="output" readonly></textarea>

<script>
    document.getElementById("printBtn").addEventListener("click", () => {
        window.print();
    });
    const list = [
        "김나은","김민지","김준석","김준수","박시연","박준후",
        "백지민","변상민","서현수","송승우","안태은","양우진",
        "오윤하","우나현","이다인","이서준","이승원","이연재",
        "이정인","이준혁","임은후","정재민","조소현","조정우",
        "최석주","최이서","최재원","추서진","한린","황준성","황지우"
    ];

    // const seatGrid = document.getElementById("seatGrid");

    const seatPrices = [
        10, 15, 30, 30, 30, 30, //lastSeat 따로
        15, 20, 35, 35, 30, 30,
        20, 25, 35, 40, 40, 30,
        20,25, 30, 30, 30, 25,
        20,20 ,20, 20, 20, 20
    ];

    const seatGrid = document.getElementById("seatGrid");

    // ✅ 이 블럭만 남기고 나머지 seat 생성 관련은 삭제
    for (let i = 0; i < seatPrices.length; i++) {
        const seat = createSeat(i);
        seatGrid.appendChild(seat);
    }


    const lastSeat = createSeat();
    lastSeat.classList.add("last-seat");
    lastSeat.innerHTML = `
            <input class="name" placeholder="이름" />
            <input class="price" type="number" placeholder="10" />
        `;
    seatGrid.appendChild(lastSeat);
    // const seats = document.getElementsByClassName("seat last-seat");
    // for (let i = 0; i < seats.length; i++) {
    //     seats[i].placeholder = "10";
    // }

    function createSeat(index) {
        const seat = document.createElement("div");
        seat.className = "seat";

        const price = seatPrices[index];
        const placeholder = price !== "" ? `placeholder="${price}"` : "";

        seat.innerHTML = `
            <input class="name" placeholder="이름" />
            <input class="price" type="number" ${placeholder} />
        `;


        seat.addEventListener("contextmenu", e => {
            e.preventDefault();
            seat.classList.toggle("flagged");
        });

        return seat;
    }

    // document.getElementById("applyBtn").addEventListener("click", () => {
    //     const names = document.querySelectorAll(".name");
    //     const prices = document.querySelectorAll(".price");
    //     const tempMap = {};
    //
    //     for (let i = 0; i < names.length; i++) {
    //         const name = names[i].value.trim();
    //         const price = prices[i].value.trim();
    //         if (list.includes(name)) {
    //             tempMap[name] = price ? Number(price) : 0;
    //         }
    //     }
    //
    //     const orderedResult = list.map(name => {
    //         return `"${name}": ${tempMap[name] ?? 0}`;
    //     }).join(",\n");
    //
    //     document.getElementById("output").value = `{\n${orderedResult}\n}`;
    // });
    const API_KEY = "$2a$10$v8MnmFSL/GoywF.qohAheOJAFCQDPmBW20gtMMHbxdN/zrkvUU1MW"; // 본인 키로 교체
    const BIN_ID = "68918ce17b4b8670d8ad6816"; // 본인 BIN ID로 교체

    async function saveToJsonBin(data) {
        try {
            const response = await fetch(`https://api.jsonbin.io/v3/b/68918ce17b4b8670d8ad6816`, {
                method: "PUT",  // 기존 BIN 덮어쓰기 (새로 만들려면 POST)
                headers: {
                    "Content-Type": "application/json",
                    "X-Master-Key": "$2a$10$v8MnmFSL/GoywF.qohAheOJAFCQDPmBW20gtMMHbxdN/zrkvUU1MW",
                    "X-Bin-Versioning": "false"
                },
                body: JSON.stringify(data)
            });
            if (!response.ok) {
                throw new Error(`저장 실패: ${response.statusText}`);
            }
            alert("결과가 jsonbin.io에 저장되었습니다.");
        } catch (error) {
            alert("저장 중 오류가 발생했습니다: " + error.message);
        }
    }
    // document.getElementById("applyBtn").addEventListener("click", () => {
    //     const names = document.querySelectorAll(".name");
    //     const prices = document.querySelectorAll(".price");
    //     const tempMap = {};
    //
    //     for (let i = 0; i < names.length; i++) {
    //         const name = names[i].value.trim();
    //         const price = prices[i].value.trim();
    //         if (list.includes(name)) {
    //             tempMap[name] = price ? Number(price) : 0;
    //         }
    //     }
    //
    //     // 배열로 변환
    //     const orderedArray = list.map(name => ({
    //         name: name,
    //         price: tempMap[name] ?? 0
    //     }));
    //
    //     document.getElementById("output").value = JSON.stringify(orderedArray, null, 2);
    //
    //     saveToJsonBin(orderedArray);
    //     console.log("tempMap:", tempMap); // 여기에 추가
    //
    // });
        const namesInputs = document.querySelectorAll(".name");
        const pricesInputs = document.querySelectorAll(".price");

        // 학생 이름 배열 복사 후 셔플 함수
        // function shuffle(array) { //테스트용 함수 실사용시 주석 처리 바람,.
        //     for (let i = array.length - 1; i > 0; i--) {
        //         const j = Math.floor(Math.random() * (i + 1));
        //         [array[i], array[j]] = [array[j], array[i]];
        //     }
        //     return array;
        // }

        // 학생 리스트 셔플 후 이름 31개 준비 (list는 원래 학생 배열)
        // const shuffledList = shuffle([...list]);
        //
        // // 만약 학생 수 < 31일 경우, 부족한 만큼 다시 반복해서 채움
        // while (shuffledList.length < 31) {
        //     shuffledList.push(...shuffle([...list]));
        // }
        //
        // // 31개 이름 채우기
        // for (let i = 0; i < 31; i++) {
        //     namesInputs[i].value = shuffledList[i];
        //     pricesInputs[i].value = Math.floor(Math.random() * 91) + 10; // 10~100 랜덤
        // }

        /*test :*/
    document.getElementById("saveBtn").addEventListener("click", () => {
        const names = document.querySelectorAll(".name");
        const prices = document.querySelectorAll(".price");
        const seats = document.querySelectorAll(".seat");

        const priceArray = []; // 첫 번째 JSON: 자리값 배열
        const positionMap = {}; // 두 번째 JSON: 위치 정보



        // 실제 저장 함수는 원한다면 아래 주석 풀고 사용하세요.
        for (let i = 0; i < list.length; i++) {
            const name = list[i];
            let found = false;

            for (let j = 0; j < names.length; j++) {
                if (names[j].value.trim() === name) {
                    const row = Math.floor(j / 6);
                    const col = j % 6;
                    let pos = `${row + 1}*${col + 1}`;
                    if (seats[j].classList.contains("flagged")) {
                        pos += "-red";
                    }

                    positionMap[name] = pos;
                    const val = prices[j].value.trim();
                    priceArray.push(val || "0");
                    found = true;
                    break;
                }
            }

            if (!found) {
                positionMap[name] = "";
                priceArray.push("0");
            }
        }
        const outputText =
            `자리값 배열 (priceArray):
${JSON.stringify(priceArray, null, 2)}

자리 위치 맵 (positionMap):
${JSON.stringify(positionMap, null, 2)}
//자리 위치 실제와 다름`;

        document.getElementById("output").value = outputText;

        console.log("자리값 JSON:", JSON.stringify(priceArray, null, 2));
        console.log("자리위치 JSON:", JSON.stringify(positionMap, null, 2));
        alert("저장 성공")

        // 여기서 각각 따로 저장 가능
        saveToJsonBin1(priceArray);       // 자리값
        saveToJsonBin2(positionMap);      // 자리위치
    });

    const BIN_ID_PRICE = "68921897ae596e708fc23d80";
    const BIN_ID_POS = "689218ac7b4b8670d8add76b\n";

    async function saveToJsonBin1(data) {
        await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID_PRICE}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                "X-Master-Key": API_KEY,
                "X-Bin-Versioning": "false"
            },
            body: JSON.stringify(data)
        });
    }

    async function saveToJsonBin2(data) {
        await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID_POS}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                "X-Master-Key": API_KEY,
                "X-Bin-Versioning": "false"
            },
            body: JSON.stringify(data)
        });
    }
/*
    async function loadFromJsonBin() {
        try {
            const [priceRes, posRes] = await Promise.all([
                fetch(`https://api.jsonbin.io/v3/b/${BIN_ID_PRICE}/latest`, {
                    headers: {
                        "X-Master-Key": API_KEY
                    }
                }),
                fetch(`https://api.jsonbin.io/v3/b/${BIN_ID_POS}/latest`, {
                    headers: {
                        "X-Master-Key": API_KEY
                    }
                })
            ]);

            const priceData = (await priceRes.json()).record;
            const posData = (await posRes.json()).record;

            // 모든 좌석 초기화
            document.querySelectorAll('.seat').forEach(seat => {
                seat.classList.remove('flagged');
                seat.querySelector('.name').value = "";
                seat.querySelector('.price').value = "";
            });

            list.forEach((name, i) => {
                const positionStr = posData[name]; // e.g., "2*3", "5*0-red"
                if (!positionStr) return;

                const isRed = positionStr.endsWith("-red");
                const [row, col] = positionStr.replace("-red", "").split("*").map(Number);
                const index = (row * 6 + col >= 30) ? 30 : (row * 6 + col);  // 마지막 좌석 보정

                const seat = document.querySelectorAll('.seat')[index];
                if (seat) {
                    seat.querySelector('.name').value = name;
                    seat.querySelector('.price').value = priceData[list.indexOf(name)] ?? 0;
                    if (isRed) seat.classList.add("flagged");
                }
            });

            alert("자리 데이터를 성공적으로 불러왔습니다!");
        } catch (err) {
            alert("불러오기 실패: " + err.message);
            console.error(err);
        }
    }
    // document.getElementById("loadBtn").addEventListener("click", loadFromJsonBin);
*/
</script>
</body>
</html>
