<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>자리 경매 시스템</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background: #f6faff;
        }

        .fullscreen-btn {
            padding: 8px 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .fullscreen-btn:hover {
            background: #2980b9;
        }

        .seat-grid-container {
            position: relative;
        }

        .seat-grid-container.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #f6faff;
            z-index: 9999;
            padding: 40px;
            box-sizing: border-box;
            overflow: auto;
        }

        .seat-grid-container.fullscreen .seat-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            max-width: 1400px;
            margin: 0 auto;
            grid-gap: 20px;
        }

        .seat-grid-container.fullscreen .seat {
            height: 120px;
            font-size: 18px;
        }

        .seat-grid-container.fullscreen .seat input {
            font-size: 16px;
            padding: 5px;
        }

        .seat-grid-container.fullscreen .last-seat-1,
        .seat-grid-container.fullscreen .last-seat-2 {
            width: auto;
            position: relative;
            left: 0;
            top: 0;
        }

        .seat-grid {
            display: grid;
            grid-template-columns: repeat(6, 100px);
            grid-gap: 10px;
            margin-bottom: 20px;
            position: relative;
        }

        .seat {
            background: #d5f0ff;
            border: 1px solid #bbb;
            border-radius: 4px;
            padding: 5px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 60px;
            transition: background 0.3s;
        }

        .seat input {
            border: none;
            background: transparent;
            text-align: center;
            font-size: 12px;
            padding: 2px;
            margin: 1px 0;
        }

        .seat input[type="number"] {
            ime-mode: disabled;
        }

        .seat input:focus {
            outline: none;
            background: #fff8cc;
        }

        .seat.flagged {
            background: #ffcccc;
        }

        .last-seat-1 {
            position: absolute;
            width: 100px;
            top: 0px;
            left: 700px;
        }

        .last-seat-2 {
            position: absolute;
            width: 100px;
            top: 80px;
            left: 700px;
        }

        button {
            padding: 10px 20px;
            background: #5fcf80;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }

        #output {
            white-space: pre;
            margin-top: 20px;
            background: #eee;
            padding: 10px;
            font-family: monospace;
            width: 90%;
            height: 200px;
        }

        .status-bar {
            margin: 10px 0;
            padding: 10px;
            background: #e8f5e9;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
        }

        .status-bar.saving {
            background: #fff3cd;
        }

        .status-bar.error {
            background: #f8d7da;
        }

        @media print {
            body {
                margin: 0;
                padding: 0;
            }
            h2, #output, #printBtn, #saveBtn, .status-bar {
                display: none;
            }
            .seat-grid {
                width: 100%;
            }
        }
    </style>
</head>
<body>
<h2>자리 경매 (총 32석)</h2>
<h4>팁 : Tab 키를 눌러 커서를 옆 자리로 이동하세요.</h4>

<div class="status-bar" id="statusBar">자동저장 대기중...</div>

<div class="seat-grid-container" id="seatGridContainer">
    <button class="fullscreen-btn" id="fullscreenBtn">⛶ 전체화면</button>
    <br />
    <br />
    <div class="seat-grid" id="seatGrid"></div>
</div>

<div style="text-align: center;">
    <button id="printBtn">인쇄</button>
    <button id="saveBtn" style="margin-left: 10px; background:#444;">즉시 저장</button>
    <button id="loadBtn" style="margin-left: 10px; background:#9b59b6;">불러오기</button>
    <button id="clearBtn" style="margin-left: 10px; background:#e74c3c;">초기화</button>
    <button id="testBtn" style="margin-left: 10px; background:#f39c12; display: none;">테스트 채우기</button>
</div>

<textarea id="output" readonly></textarea>

<script>
    const list = [
        "김나은","김민지","김준석","김준수","박시연","박준후",
        "백지민","변상민","서현수","송승우","안태은","양우진",
        "오윤하","우나현","이다인","이서준","이승원","이연재",
        "이정인","이준혁","임은후","정재민","조소현","조정우",
        "최석주","최이서","최재원","추서진","한린","황준성","황지우", "김다인"
    ];

    const seatPrices = [
        10, 15, 30, 30, 30, 30,
        15, 20, 35, 35, 30, 30,
        20, 25, 35, 40, 40, 30,
        20, 25, 30, 30, 30, 25,
        20, 20, 20, 20, 20, 20,
        10, 5
    ];

    const API_KEY = "$2a$10$v8MnmFSL/GoywF.qohAheOJAFCQDPmBW20gtMMHbxdN/zrkvUU1MW";
    const BIN_ID_PRICE = "68921897ae596e708fc23d80";
    const BIN_ID_POS = "689218ac7b4b8670d8add76b";

    const seatGrid = document.getElementById("seatGrid");
    const statusBar = document.getElementById("statusBar");
    let autoSaveInterval = null;
    let isFirstSave = true;

    function updateStatus(message, type = 'normal') {
        statusBar.textContent = message;
        statusBar.className = 'status-bar';
        if (type === 'saving') statusBar.classList.add('saving');
        if (type === 'error') statusBar.classList.add('error');
    }

    function createSeat(index, previousName = "") {
        const seat = document.createElement("div");
        seat.className = "seat";
        seat.dataset.index = index;

        const namePlaceholder = previousName || "이름";

        seat.innerHTML = `
            <input class="name" placeholder="${namePlaceholder}" data-original-placeholder="${namePlaceholder}" />
            <input class="price" type="text" placeholder="${seatPrices[index]}" />
        `;

        seat.addEventListener("contextmenu", e => {
            e.preventDefault();
            seat.classList.toggle("flagged");
        });

        const nameInput = seat.querySelector(".name");
        nameInput.addEventListener("input", () => {
            if (nameInput.value.trim()) {
                seat.classList.add("flagged");
            } else {
                seat.classList.remove("flagged");
            }
        });

        const priceInput = seat.querySelector(".price");
        priceInput.addEventListener("input", (e) => {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });

        return seat;
    }

    async function loadData() {
        try {
            updateStatus("데이터 불러오는 중...", 'saving');

            const [priceRes, posRes] = await Promise.all([
                fetch(`https://api.jsonbin.io/v3/b/${BIN_ID_PRICE}/latest`, {
                    headers: { "X-Master-Key": API_KEY }
                }),
                fetch(`https://api.jsonbin.io/v3/b/${BIN_ID_POS}/latest`, {
                    headers: { "X-Master-Key": API_KEY }
                })
            ]);

            const priceData = (await priceRes.json()).record;
            const posData = (await posRes.json()).record;

            const names = document.querySelectorAll(".name");
            const prices = document.querySelectorAll(".price");
            const seats = document.querySelectorAll(".seat");

            // 먼저 모든 자리 초기화
            names.forEach(input => {
                input.value = "";
                // placeholder를 원래 placeholder로 복원
                const originalPlaceholder = input.dataset.originalPlaceholder;
                if (originalPlaceholder) {
                    input.placeholder = originalPlaceholder;
                }
            });
            prices.forEach(input => input.value = "");
            seats.forEach(seat => seat.classList.remove("flagged"));

            // 위치 데이터로 자리 채우기
            for (const [name, pos] of Object.entries(posData)) {
                if (!pos) continue;

                const isRed = pos.includes("-red");
                const posClean = pos.replace("-red", "");
                const [row, col] = posClean.split("*").map(Number);
                const seatIndex = row * 6 + col;

                if (seatIndex >= 0 && seatIndex < 32) {
                    names[seatIndex].value = name;
                    // placeholder를 현재 이름으로 업데이트하고 저장
                    names[seatIndex].placeholder = name;
                    names[seatIndex].dataset.originalPlaceholder = name;

                    const nameIdx = list.indexOf(name);
                    if (nameIdx !== -1 && priceData[nameIdx]) {
                        prices[seatIndex].value = priceData[nameIdx];
                    }

                    if (isRed) {
                        seats[seatIndex].classList.add("flagged");
                    }
                }
            }

            updateStatus("불러오기 완료!", 'normal');
            setTimeout(() => updateStatus("자동저장 활성화"), 2000);
            isFirstSave = false;

        } catch (err) {
            console.log("불러오기 실패:", err);
            updateStatus("불러올 데이터가 없습니다.", 'error');
            setTimeout(() => updateStatus("자동저장 활성화"), 2000);
        }
    }

    async function saveData(showAlert = false) {
        try {
            updateStatus("저장 중...", 'saving');

            const names = document.querySelectorAll(".name");
            const prices = document.querySelectorAll(".price");
            const seats = document.querySelectorAll(".seat");

            if (isFirstSave) {
                // 첫 저장: DB 초기화
                const emptyPriceArray = new Array(list.length).fill(0);
                const emptyPositionMap = {};
                list.forEach(name => emptyPositionMap[name] = "");

                await Promise.all([
                    saveToJsonBin(BIN_ID_PRICE, emptyPriceArray),
                    saveToJsonBin(BIN_ID_POS, emptyPositionMap)
                ]);

                isFirstSave = false;
            }

            const priceArray = [];
            const positionMap = {};

            for (let i = 0; i < list.length; i++) {
                const name = list[i];
                let found = false;

                for (let j = 0; j < names.length; j++) {
                    if (names[j].value.trim() === name) {
                        const row = Math.floor(j / 6);
                        const col = j % 6;
                        let pos = `${row}*${col}`;

                        if (seats[j].classList.contains("flagged")) {
                            pos += "-red";
                        }

                        positionMap[name] = pos;
                        const val = prices[j].value.trim();
                        const finalPrice = val || prices[j].placeholder;
                        priceArray.push(parseInt(finalPrice) || 0);
                        found = true;
                        break;
                    }
                }

                if (!found) {
                    positionMap[name] = "";
                    priceArray.push(0);
                }
            }

            await Promise.all([
                saveToJsonBin(BIN_ID_PRICE, priceArray),
                saveToJsonBin(BIN_ID_POS, positionMap)
            ]);

            const now = new Date().toLocaleTimeString('ko-KR');
            updateStatus(`저장 완료 (${now})`, 'normal');

            if (showAlert) {
                alert("저장 완료!");
            }

        } catch (err) {
            console.error("저장 실패:", err);
            updateStatus("저장 실패!", 'error');
        }
    }

    async function saveToJsonBin(binId, data) {
        await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                "X-Master-Key": API_KEY,
                "X-Bin-Versioning": "false"
            },
            body: JSON.stringify(data)
        });
    }

    function startAutoSave() {
        if (autoSaveInterval) {
            clearInterval(autoSaveInterval);
        }

        autoSaveInterval = setInterval(() => {
            saveData(false);
        }, 10000); // 10초마다 자동 저장
    }

    async function init() {
        // 먼저 이전 데이터 로드 시도
        let previousPositions = {};
        try {
            const posRes = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID_POS}/latest`, {
                headers: { "X-Master-Key": API_KEY }
            });
            previousPositions = (await posRes.json()).record;
        } catch (err) {
            console.log("이전 자리 데이터 없음");
        }

        // 각 자리에 이전 학생 이름을 placeholder로 설정하는 함수
        function getPreviousNameAt(index) {
            const row = Math.floor(index / 6);
            const col = index % 6;

            for (const [name, pos] of Object.entries(previousPositions)) {
                if (!pos) continue;
                const posClean = pos.replace("-red", "");
                const [r, c] = posClean.split("*").map(Number);
                if (r === row && c === col) return name;
            }
            return "";
        }

        // 30석 (6x5)
        for (let i = 0; i < 30; i++) {
            const prevName = getPreviousNameAt(i);
            const seat = createSeat(i, prevName);
            seatGrid.appendChild(seat);
        }

        // 오른쪽 7번째 열 2자리
        const prevName31 = getPreviousNameAt(30);
        const seat31 = createSeat(30, prevName31);
        seat31.classList.add("last-seat-1");
        seatGrid.appendChild(seat31);

        const prevName32 = getPreviousNameAt(31);
        const seat32 = createSeat(31, prevName32);
        seat32.classList.add("last-seat-2");
        seatGrid.appendChild(seat32);

        // 자동저장 시작
        startAutoSave();
        updateStatus("자동저장 활성화 (10초마다)", 'normal');
    }

    // 버튼 이벤트
    document.getElementById("printBtn").addEventListener("click", () => {
        window.print();
    });

    document.getElementById("saveBtn").addEventListener("click", () => {
        saveData(true);
    });

    document.getElementById("loadBtn").addEventListener("click", () => {
        if (confirm("현재 입력된 내용을 무시하고 저장된 데이터를 불러올까요?")) {
            loadData();
        }
    });

    document.getElementById("clearBtn").addEventListener("click", () => {
        if (confirm("모든 입력을 지우고 초기화할까요?")) {
            const names = document.querySelectorAll(".name");
            const prices = document.querySelectorAll(".price");
            const seats = document.querySelectorAll(".seat");

            names.forEach(input => {
                input.value = "";
                // placeholder는 원래 값으로 복원
                const originalPlaceholder = input.dataset.originalPlaceholder;
                if (originalPlaceholder) {
                    input.placeholder = originalPlaceholder;
                }
            });
            prices.forEach(input => input.value = "");
            seats.forEach(seat => seat.classList.remove("flagged"));

            isFirstSave = true;
            updateStatus("초기화 완료", 'normal');
        }
    });

    document.getElementById("fullscreenBtn").addEventListener("click", () => {
        const container = document.getElementById("seatGridContainer");
        const btn = document.getElementById("fullscreenBtn");

        container.classList.toggle("fullscreen");

        if (container.classList.contains("fullscreen")) {
            btn.textContent = "✕ 닫기";
        } else {
            btn.textContent = "⛶ 전체화면";
        }
    });

    document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
            const container = document.getElementById("seatGridContainer");
            const btn = document.getElementById("fullscreenBtn");
            if (container.classList.contains("fullscreen")) {
                container.classList.remove("fullscreen");
                btn.textContent = "⛶ 전체화면";
            }
        }
    });

    document.getElementById("testBtn").addEventListener("click", () => {
        const shuffled = [...list].sort(() => Math.random() - 0.5);
        const names = document.querySelectorAll(".name");
        const prices = document.querySelectorAll(".price");

        for (let i = 0; i < Math.min(32, shuffled.length); i++) {
            names[i].value = shuffled[i];
            prices[i].value = Math.floor(Math.random() * 91) + 10;
            names[i].dispatchEvent(new Event('input'));
        }
    });

    init();
</script>
</body>
</html>
