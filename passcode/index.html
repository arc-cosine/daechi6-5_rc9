<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
<script>
    const PASSWORD_BIN_ID = "68974439ae596e708fc5ec41";
    const DATA_BIN_ID = "68974444ae596e708fc5ec51";
    const API_KEY = "$2a$10$v8MnmFSL/GoywF.qohAheOJAFCQDPmBW20gtMMHbxdN/zrkvUU1MW";

    async function fetchJsonbin(binId) {
        const res = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
            headers: {
                'X-Master-Key': API_KEY
            }
        });
        if (!res.ok) throw new Error(`jsonbin API error: ${res.status}`);
        const json = await res.json();
        return json.record;
    }

    async function sha256(message) {
        const msgBuffer = new TextEncoder().encode(message);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    /**
     * x: 암구호 (plain text)
     * y: 실제 데이터 키명
     * z: 미사용 (필요하면 확장용)
     */
    async function importValue(x, y, z) {
        try {
            const passwordDB = await fetchJsonbin(PASSWORD_BIN_ID);
            const inputHash = await sha256(x);

            // localStorage에서 실패 횟수 가져오기 (없으면 0)
            let failCount = parseInt(localStorage.getItem("failCount")) || 0;

            if (
                inputHash === passwordDB.passHash ||
                inputHash === passwordDB.passHash2 ||
                inputHash === passwordDB.passHash3
            ) {
                // 성공하면 실패 횟수 초기화
                if (failCount > 0) {
                    localStorage.removeItem("failCount");
                }

                const dataDB = await fetchJsonbin(DATA_BIN_ID);
                if (y in dataDB) {
                    return dataDB[y];
                } else {
                    console.error(`키 '${y}'가 실제 데이터 DB에 없습니다.`);
                    return null;
                }
            } else {
                failCount++;
                localStorage.setItem("failCount", failCount);

                const maxFail = 3;
                const remain = maxFail - failCount;

                if (remain <= 0) {
                    console.error("암구호가 일치하지 않습니다. 3회 이상 틀려 사이트 접속이 차단됩니다.");
                    // 접속 차단 처리 (예: 화면 리다이렉트 등) 여기 추가 가능
                } else {
                    console.error(`암구호가 일치하지 않습니다. 3회 이상 틀릴 시 본 기기에서 사이트 접속이 차단됩니다. 남은 횟수 : ${remain}회`);
                }

                return null;
            }
        } catch (e) {
            console.error("importValue 오류:", e);
            return null;
        }
    }
</script>
</body>
</html><!--암구호 시스템-->
