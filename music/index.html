<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ì‹ ì²­ê³¡ ì‹ ì²­ê¸°</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* small custom tweaks */
        html, body, #app {
            height: 100%;
        }
        body {
            background: linear-gradient(180deg, #0f0520 0%, #140725 60%);
        }
        .glass {
            backdrop-filter: blur(6px) saturate(120%);
            -webkit-backdrop-filter: blur(6px) saturate(120%);
        }
    </style>
</head>
<body class="text-slate-100 antialiased">
<div id="app" class="min-h-screen flex items-center justify-center p-6">
    <div class="w-full max-w-3xl mx-auto">

        <!-- í—¤ë” -->
        <header class="mb-6 flex items-center justify-between">
            <h1 class="text-3xl font-extrabold tracking-tight bg-clip-text text-transparent"
                style="color : white;">
                ì‹ ì²­ê³¡ ì‹ ì²­ê¸°
            </h1>
            <div class="flex gap-2 items-center">
                <button id="teacherBtn"
                        class="px-3 py-1 rounded-full text-sm font-medium glass hover:scale-105 transition-transform">
                    êµì‚¬ìš© ë³´ê¸°
                </button>
                <button id="clearLocal" title="ë¡œì»¬ ìºì‹œ ì´ˆê¸°í™”"
                        class="px-3 py-1 rounded-full text-sm font-medium bg-slate-700/40 hover:bg-slate-700/60">
                    ì´ˆê¸°í™”
                </button>
            </div>
        </header>

        <!-- ë©”ì¸ ì¹´ë“œ -->
        <main class="glass bg-gradient-to-br from-white/3 to-white/5 rounded-2xl p-6 shadow-2xl border border-white/5">
            <div class="grid md:grid-cols-2 gap-6 items-start">

                <!-- í•™ìƒ ì‹ ì²­ -->
                <section>
                    <h2 class="text-xl font-semibold mb-3">í•™ìƒ â€” ì‹ ì²­í•˜ê¸°</h2>
                    <form id="requestForm" class="space-y-4">
                        <div>
                            <label class="block text-sm mb-1">ë…¸ë˜ ì œëª©</label>
                            <input id="title" required
                                   class="w-full rounded-lg p-3 bg-white/5 placeholder:text-slate-300 outline-none border border-white/6"
                                   placeholder="ì˜ˆ: Butter" />
                        </div>
                        <div>
                            <label class="block text-sm mb-1">YouTube ë§í¬</label>
                            <input id="url" required class="w-full rounded-lg p-3 bg-white/5 placeholder:text-slate-300 outline-none border border-white/6" placeholder="https://www.youtube.com/watch?v=xxxxxxxxxxx" />
                        </div>
                        <div class="flex gap-2">
                            <input id="nickname"
                                   placeholder="ë‹‰ë„¤ì„ (ì˜ˆ: ì•„ì½”)"
                                   class="flex-1 rounded-lg p-3 bg-white/5 outline-none border border-white/6" />
                            <button type="submit"
                                    class="px-4 py-2 rounded-lg bg-gradient-to-r from-purple-500 to-violet-700 font-semibold shadow-lg">
                                ì‹ ì²­
                            </button>
                        </div>
                        <p class="text-xs text-slate-300">
                            ì…ë ¥í•˜ë©´ ëª©ë¡ì´ ì‹¤ì‹œê°„ìœ¼ë¡œ êµì‚¬ í™”ë©´ì— í‘œì‹œë©ë‹ˆë‹¤.
                        </p>
                    </form>
                    <div id="studentNotice" class="mt-4 text-sm text-slate-300/80"></div>
                </section>

                <!-- ì‹¤ì‹œê°„ ì‹ ì²­ ëª©ë¡ -->
                <section>
                    <div class="flex items-center justify-between">
                        <h2 id="listTitle" class="text-xl font-semibold">ì‹¤ì‹œê°„ ì‹ ì²­ ëª©ë¡</h2>
                        <div class="text-sm text-slate-300">
                            ìš”ì²­ ìˆ˜: <span id="count">0</span>
                        </div>
                    </div>
                    <ul id="requests" class="mt-4 space-y-3 max-h-96 overflow-auto pr-2"></ul>

                    <div id="teacherControls" class="mt-4 hidden">
                        <h3 class="text-sm font-medium mb-2">êµì‚¬ ë„êµ¬</h3>
                        <div class="flex gap-2">
                            <button id="pinFirst" class="px-4 py-2 rounded-lg bg-gradient-to-r from-purple-500 to-violet-700 font-semibold shadow-lg">ìˆœì„œ ë³€ê²½</button>
                            <button id="removeAll" class="px-4 py-2 rounded-lg bg-gradient-to-r from-purple-500 to-violet-700 font-semibold shadow-lg">ëª¨ë‘ ì‚­ì œ</button>
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <footer class="mt-6 text-sm text-center text-slate-400">
            Made by í•œì•„ë¦° with â¤ï¸
        </footer>
    </div>
</div>
<!-- YouTube Modal -->
<div id="videoModal" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-50">
    <div class="relative w-full h-full flex items-center justify-center">
        <iframe id="videoFrame" class="w-[90%] h-[80%] rounded-xl shadow-xl" src="" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
        <button id="closeModal" class="absolute top-5 right-5 px-4 py-2 bg-rose-600 rounded-lg">ë‹«ê¸° âœ•</button>
    </div>
</div>

<!-- Scaledrone client -->
<script src="https://cdn.scaledrone.com/scaledrone.min.js"></script>

<script>
    /*****************************************************************
     * ì„¤ì •: ì•„ë˜ CHANNEL_IDë¥¼ Scaledrone ëŒ€ì‹œë³´ë“œì—ì„œ ë°œê¸‰ë°›ì€ ê°’ìœ¼ë¡œ
     * ë°”ê¿”ì£¼ì„¸ìš”. roomNameì€ ê°™ì€ ê°’ì„ ì“°ë©´ ë™ì¼í•œ ì±„íŒ…ë°©ìœ¼ë¡œ ì—°ê²°ë©ë‹ˆë‹¤.
     *****************************************************************/
    const CHANNEL_ID = 'SnuhZa1gvqPm0btj'; // <<-- ì—¬ê¸°ë¥¼ ë°”ê¾¸ì„¸ìš”
    const ROOM_NAME = 'song-requests';
    const TEACHER_PASSWORD = 'teacher123'; // ë°ëª¨ìš©. í•„ìš”í•˜ë©´ ë³€ê²½í•˜ì„¸ìš”.

    // UI elements
    const form = document.getElementById('requestForm');
    const titleInput = document.getElementById('title');
    const urlInput = document.getElementById('url');
    const nickInput = document.getElementById('nickname');
    const requestsList = document.getElementById('requests');
    const countEl = document.getElementById('count');
    const teacherBtn = document.getElementById('teacherBtn');
    const teacherControls = document.getElementById('teacherControls');
    const listTitle = document.getElementById('listTitle');
    const studentNotice = document.getElementById('studentNotice');
    const clearLocal = document.getElementById('clearLocal');

    let isTeacher = false;
    let items = JSON.parse(localStorage.getItem('songRequests') || '[]');

    // helper: YouTube ID ì¶”ì¶œ
    function extractYouTubeID(url) {
        if (!url) return null;
        try {
            const u = new URL(url);
            if (u.hostname.includes('youtube.com')) return new URLSearchParams(u.search).get('v');
            if (u.hostname.includes('youtu.be')) return u.pathname.slice(1);
        } catch (e) { }
        const m = url.match(/(?:v=|youtu\.be\/)([A-Za-z0-9_-]{6,})/);
        return m ? m[1] : null;
    }

    function render() {
        requestsList.innerHTML = '';
        items.slice().reverse().forEach(req => {
            const id = req.id;
            const vId = extractYouTubeID(req.url);

            const li = document.createElement('li');
            li.className = 'bg-white/3 rounded-xl p-3 flex gap-3 items-start border border-white/4';
            li.innerHTML = `
          <div class="w-16 h-12 rounded-md overflow-hidden flex-shrink-0 bg-slate-800/30">
            ${vId
                ? `<img src="https://img.youtube.com/vi/${vId}/mqdefault.jpg" alt="thumb" class="w-full h-full object-cover"/>`
                : `<div class="w-full h-full flex items-center justify-center text-xs text-slate-400">No</div>`}
          </div>
          <div class="flex-1">
            <div class="flex items-baseline justify-between gap-3">
              <div>
                <div class="font-semibold">${escapeHtml(req.title)}</div>
                <div class="text-xs text-slate-300">${escapeHtml(req.nick || 'ìµëª…')} â€¢ ${new Date(req.ts).toLocaleString()}</div>
              </div>
              <div class="flex gap-2 items-center">
                ${isTeacher ? `<button data-id="${id}"  class="deleteBtn px-3 px-1 rounded-lg bg-gradient-to-r from-purple-500 to-violet-700 font-semibold shadow-lg">ğŸ—‘ï¸</button>` : ''}
                ${req.url ? `<button data-url="${escapeAttr(req.url)}" class="ytBtn text-xs px-2 py-1 rounded bg-white/6">YouTube</button>` : ''}

              </div>
            </div>
            ${req.note ? `<div class="mt-2 text-sm text-slate-300">${escapeHtml(req.note)}</div>` : ''}
          </div>
        `;
            requestsList.appendChild(li);
        });
        countEl.textContent = items.length;

        // ì‚­ì œ ë²„íŠ¼ í•¸ë“¤ëŸ¬
        document.querySelectorAll('.deleteBtn').forEach(btn => {
            btn.onclick = () => {
                const id = btn.dataset.id;
                items = items.filter(it => it.id !== id);
                saveAndRender();
                publish({ type: 'delete', id });
            };
        });
        // attach YouTube open handlers
        document.querySelectorAll('.ytBtn').forEach(btn => {
            btn.onclick = () => {
                const url = btn.dataset.url;
                const vId = extractYouTubeID(url);
                if (vId) {
                    videoFrame.src = `https://www.youtube.com/embed/${vId}?autoplay=1`;
                    videoModal.classList.remove('hidden');
                }
            };
        });

// modal close
        document.getElementById('closeModal').onclick = () => {
            videoFrame.src = "";
            videoModal.classList.add('hidden');
        };
    }

    function escapeHtml(s) {
        if (!s) return '';
        return s.replace(/[&<>\"']/g, c => ({
            '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
        })[c]);
    }

    function escapeAttr(s) {
        return (s || '').replace(/\"/g, '&quot;');
    }

    function saveAndRender() {
        localStorage.setItem('songRequests', JSON.stringify(items));
        render();
    }

    // --- Scaledrone ---
    let drone = null;
    let room = null;

    function setupScaledrone() {
        if (!CHANNEL_ID || CHANNEL_ID.includes('REPLACE')) {
            studentNotice.textContent = 'âš ï¸ Scaledrone ì±„ë„ IDë¥¼ ì„¤ì •í•˜ì„¸ìš”.';
            return;
        }
        drone = new Scaledrone(CHANNEL_ID);

        drone.on('open', error => {
            if (error) {
                console.error('Scaledrone open error', error);
                studentNotice.textContent = 'Scaledrone ì—°ê²° ì‹¤íŒ¨: ' + error;
                return;
            }
            studentNotice.textContent = 'ì—°ê²° ì„±ê³µ';
        });

        room = drone.subscribe(ROOM_NAME);
        room.on('open', () => console.log('room opened'));
        room.on('data', (data) => {
            if (!data) return;
            if (data.type === 'add' && data.payload) {
                if (items.some(it => it.id === data.payload.id)) return;
                items.push(data.payload);
                saveAndRender();
            } else if (data.type === 'delete' && data.id) {
                items = items.filter(it => it.id !== data.id);
                saveAndRender();
            } else if (data.type === 'clear') {
                items = [];
                saveAndRender();
            } else if (data.type === 'reorder' && Array.isArray(data.payload)) {
                items = data.payload;
                saveAndRender();
            }
        });
    }

    function publish(obj) {
        if (!drone) return;
        try {
            drone.publish({ room: ROOM_NAME, message: obj });
        } catch (e) {
            console.warn('publish err', e);
        }
    }

    // --- ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---
    form.addEventListener('submit', e => {
        e.preventDefault();
        const title = titleInput.value.trim();
        const url = urlInput.value.trim();
        const nick = nickInput.value.trim();
        if (!title) return alert('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”');

        const item = {
            id: String(Date.now()) + '-' + Math.random().toString(36).slice(2, 8),
            title, url, nick, ts: Date.now()
        };

        items.push(item);
        saveAndRender();
        publish({ type: 'add', payload: item });

        titleInput.value = '';
        urlInput.value = '';
        studentNotice.textContent = 'ì œì¶œ ì™„ë£Œ!';
        setTimeout(() => studentNotice.textContent = '', 2500);
    });

    teacherBtn.addEventListener('click', () => {
        const pw = prompt('êµì‚¬ìš© ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
        if (pw === TEACHER_PASSWORD) {
            isTeacher = true;
            teacherControls.classList.remove('hidden');
            listTitle.textContent = 'êµì‚¬ìš© ì‹ ì²­ ëª©ë¡';
            teacherBtn.textContent = 'êµì‚¬ìš© ëª¨ë“œ (í™œì„±)';
            teacherBtn.classList.add('bg-white/6');
            render();
        } else if (pw !== null) {
            alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
        }
    });

    document.getElementById('removeAll').addEventListener('click', () => {
        if (!confirm('ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        items = [];
        saveAndRender();
        publish({ type: 'clear' });
    });

    document.getElementById('pinFirst').addEventListener('click', () => {
        if (items.length <= 1) return alert('ê³ ì •í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
        const it = items.shift();
        items.push(it);
        saveAndRender();
        publish({ type: 'reorder', payload: items });
    });

    clearLocal.addEventListener('click', () => {
        if (!confirm('ë¡œì»¬ ì €ì¥ëœ ìš”ì²­ì„ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
        localStorage.removeItem('songRequests');
        items = [];
        render();
    });

    // ì´ˆê¸° ì‹¤í–‰
    saveAndRender();
    try { setupScaledrone(); } catch (e) { console.warn(e); }
</script>
</body>
</html>
