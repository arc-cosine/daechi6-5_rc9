<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>신청곡 신청기</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* small custom tweaks */
        html, body, #app {
            height: 100%;
        }
        body {
            background: linear-gradient(180deg, #0f0520 0%, #140725 60%);
        }
        .glass {
            backdrop-filter: blur(6px) saturate(120%);
            -webkit-backdrop-filter: blur(6px) saturate(120%);
        }
    </style>
</head>
<body class="text-slate-100 antialiased">
<div id="app" class="min-h-screen flex items-center justify-center p-6">
    <div class="w-full max-w-3xl mx-auto">

        <!-- 헤더 -->
        <header class="mb-6 flex items-center justify-between">
            <h1 class="text-3xl font-extrabold tracking-tight bg-clip-text text-transparent"
                style="color : white;">
                신청곡 신청기
            </h1>
            <div class="flex gap-2 items-center">
                <button id="teacherBtn"
                        class="px-3 py-1 rounded-full text-sm font-medium glass hover:scale-105 transition-transform">
                    교사용 보기
                </button>
                <button id="clearLocal" title="로컬 캐시 초기화"
                        class="px-3 py-1 rounded-full text-sm font-medium bg-slate-700/40 hover:bg-slate-700/60">
                    초기화
                </button>
            </div>
        </header>

        <!-- 메인 카드 -->
        <main class="glass bg-gradient-to-br from-white/3 to-white/5 rounded-2xl p-6 shadow-2xl border border-white/5">
            <div class="grid md:grid-cols-2 gap-6 items-start">

                <!-- 학생 신청 -->
                <section>
                    <h2 class="text-xl font-semibold mb-3">학생 — 신청하기</h2>
                    <form id="requestForm" class="space-y-4">
                        <div>
                            <label class="block text-sm mb-1">노래 제목</label>
                            <input id="title" required
                                   class="w-full rounded-lg p-3 bg-white/5 placeholder:text-slate-300 outline-none border border-white/6"
                                   placeholder="예: Butter" />
                        </div>
                        <div>
                            <label class="block text-sm mb-1">YouTube 링크</label>
                            <input id="url" required class="w-full rounded-lg p-3 bg-white/5 placeholder:text-slate-300 outline-none border border-white/6" placeholder="https://www.youtube.com/watch?v=xxxxxxxxxxx" />
                        </div>
                        <div class="flex gap-2">
                            <input id="nickname"
                                   placeholder="닉네임 (예: 아코)"
                                   class="flex-1 rounded-lg p-3 bg-white/5 outline-none border border-white/6" />
                            <button type="submit"
                                    class="px-4 py-2 rounded-lg bg-gradient-to-r from-purple-500 to-violet-700 font-semibold shadow-lg">
                                신청
                            </button>
                        </div>
                        <p class="text-xs text-slate-300">
                            입력하면 목록이 실시간으로 교사 화면에 표시됩니다.
                        </p>
                    </form>
                    <div id="studentNotice" class="mt-4 text-sm text-slate-300/80"></div>
                </section>

                <!-- 실시간 신청 목록 -->
                <section>
                    <div class="flex items-center justify-between">
                        <h2 id="listTitle" class="text-xl font-semibold">실시간 신청 목록</h2>
                        <div class="text-sm text-slate-300">
                            요청 수: <span id="count">0</span>
                        </div>
                    </div>
                    <ul id="requests" class="mt-4 space-y-3 max-h-96 overflow-auto pr-2"></ul>

                    <div id="teacherControls" class="mt-4 hidden">
                        <h3 class="text-sm font-medium mb-2">교사 도구</h3>
                        <div class="flex gap-2">
                            <button id="pinFirst" class="px-4 py-2 rounded-lg bg-gradient-to-r from-purple-500 to-violet-700 font-semibold shadow-lg">순서 변경</button>
                            <button id="removeAll" class="px-4 py-2 rounded-lg bg-gradient-to-r from-purple-500 to-violet-700 font-semibold shadow-lg">모두 삭제</button>
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <footer class="mt-6 text-sm text-center text-slate-400">
            Made by 한아린 with ❤️
        </footer>
    </div>
</div>
<!-- YouTube Modal -->
<div id="videoModal" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-50">
    <div class="relative w-full h-full flex items-center justify-center">
        <iframe id="videoFrame" class="w-[90%] h-[80%] rounded-xl shadow-xl" src="" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
        <button id="closeModal" class="absolute top-5 right-5 px-4 py-2 bg-rose-600 rounded-lg">닫기 ✕</button>
    </div>
</div>

<!-- Scaledrone client -->
<script src="https://cdn.scaledrone.com/scaledrone.min.js"></script>

<script>
    /*****************************************************************
     * 설정: 아래 CHANNEL_ID를 Scaledrone 대시보드에서 발급받은 값으로
     * 바꿔주세요. roomName은 같은 값을 쓰면 동일한 채팅방으로 연결됩니다.
     *****************************************************************/
    const CHANNEL_ID = 'SnuhZa1gvqPm0btj'; // <<-- 여기를 바꾸세요
    const ROOM_NAME = 'song-requests';
    const TEACHER_PASSWORD = 'teacher123'; // 데모용. 필요하면 변경하세요.

    // UI elements
    const form = document.getElementById('requestForm');
    const titleInput = document.getElementById('title');
    const urlInput = document.getElementById('url');
    const nickInput = document.getElementById('nickname');
    const requestsList = document.getElementById('requests');
    const countEl = document.getElementById('count');
    const teacherBtn = document.getElementById('teacherBtn');
    const teacherControls = document.getElementById('teacherControls');
    const listTitle = document.getElementById('listTitle');
    const studentNotice = document.getElementById('studentNotice');
    const clearLocal = document.getElementById('clearLocal');

    let isTeacher = false;
    let items = JSON.parse(localStorage.getItem('songRequests') || '[]');

    // helper: YouTube ID 추출
    function extractYouTubeID(url) {
        if (!url) return null;
        try {
            const u = new URL(url);
            if (u.hostname.includes('youtube.com')) return new URLSearchParams(u.search).get('v');
            if (u.hostname.includes('youtu.be')) return u.pathname.slice(1);
        } catch (e) { }
        const m = url.match(/(?:v=|youtu\.be\/)([A-Za-z0-9_-]{6,})/);
        return m ? m[1] : null;
    }

    function render() {
        requestsList.innerHTML = '';
        items.slice().reverse().forEach(req => {
            const id = req.id;
            const vId = extractYouTubeID(req.url);

            const li = document.createElement('li');
            li.className = 'bg-white/3 rounded-xl p-3 flex gap-3 items-start border border-white/4';
            li.innerHTML = `
          <div class="w-16 h-12 rounded-md overflow-hidden flex-shrink-0 bg-slate-800/30">
            ${vId
                ? `<img src="https://img.youtube.com/vi/${vId}/mqdefault.jpg" alt="thumb" class="w-full h-full object-cover"/>`
                : `<div class="w-full h-full flex items-center justify-center text-xs text-slate-400">No</div>`}
          </div>
          <div class="flex-1">
            <div class="flex items-baseline justify-between gap-3">
              <div>
                <div class="font-semibold">${escapeHtml(req.title)}</div>
                <div class="text-xs text-slate-300">${escapeHtml(req.nick || '익명')} • ${new Date(req.ts).toLocaleString()}</div>
              </div>
              <div class="flex gap-2 items-center">
                ${isTeacher ? `<button data-id="${id}"  class="deleteBtn px-3 px-1 rounded-lg bg-gradient-to-r from-purple-500 to-violet-700 font-semibold shadow-lg">🗑️</button>` : ''}
                ${req.url ? `<button data-url="${escapeAttr(req.url)}" class="ytBtn text-xs px-2 py-1 rounded bg-white/6">YouTube</button>` : ''}

              </div>
            </div>
            ${req.note ? `<div class="mt-2 text-sm text-slate-300">${escapeHtml(req.note)}</div>` : ''}
          </div>
        `;
            requestsList.appendChild(li);
        });
        countEl.textContent = items.length;

        // 삭제 버튼 핸들러
        document.querySelectorAll('.deleteBtn').forEach(btn => {
            btn.onclick = () => {
                const id = btn.dataset.id;
                items = items.filter(it => it.id !== id);
                saveAndRender();
                publish({ type: 'delete', id });
            };
        });
        // attach YouTube open handlers
        document.querySelectorAll('.ytBtn').forEach(btn => {
            btn.onclick = () => {
                const url = btn.dataset.url;
                const vId = extractYouTubeID(url);
                if (vId) {
                    videoFrame.src = `https://www.youtube.com/embed/${vId}?autoplay=1`;
                    videoModal.classList.remove('hidden');
                }
            };
        });

// modal close
        document.getElementById('closeModal').onclick = () => {
            videoFrame.src = "";
            videoModal.classList.add('hidden');
        };
    }

    function escapeHtml(s) {
        if (!s) return '';
        return s.replace(/[&<>\"']/g, c => ({
            '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
        })[c]);
    }

    function escapeAttr(s) {
        return (s || '').replace(/\"/g, '&quot;');
    }

    function saveAndRender() {
        localStorage.setItem('songRequests', JSON.stringify(items));
        render();
    }

    // --- Scaledrone ---
    let drone = null;
    let room = null;

    function setupScaledrone() {
        if (!CHANNEL_ID || CHANNEL_ID.includes('REPLACE')) {
            studentNotice.textContent = '⚠️ Scaledrone 채널 ID를 설정하세요.';
            return;
        }
        drone = new Scaledrone(CHANNEL_ID);

        drone.on('open', error => {
            if (error) {
                console.error('Scaledrone open error', error);
                studentNotice.textContent = 'Scaledrone 연결 실패: ' + error;
                return;
            }
            studentNotice.textContent = '연결 성공';
        });

        room = drone.subscribe(ROOM_NAME);
        room.on('open', () => console.log('room opened'));
        room.on('data', (data) => {
            if (!data) return;
            if (data.type === 'add' && data.payload) {
                if (items.some(it => it.id === data.payload.id)) return;
                items.push(data.payload);
                saveAndRender();
            } else if (data.type === 'delete' && data.id) {
                items = items.filter(it => it.id !== data.id);
                saveAndRender();
            } else if (data.type === 'clear') {
                items = [];
                saveAndRender();
            } else if (data.type === 'reorder' && Array.isArray(data.payload)) {
                items = data.payload;
                saveAndRender();
            }
        });
    }

    function publish(obj) {
        if (!drone) return;
        try {
            drone.publish({ room: ROOM_NAME, message: obj });
        } catch (e) {
            console.warn('publish err', e);
        }
    }

    // --- 이벤트 핸들러 ---
    form.addEventListener('submit', e => {
        e.preventDefault();
        const title = titleInput.value.trim();
        const url = urlInput.value.trim();
        const nick = nickInput.value.trim();
        if (!title) return alert('제목을 입력하세요');

        const item = {
            id: String(Date.now()) + '-' + Math.random().toString(36).slice(2, 8),
            title, url, nick, ts: Date.now()
        };

        items.push(item);
        saveAndRender();
        publish({ type: 'add', payload: item });

        titleInput.value = '';
        urlInput.value = '';
        studentNotice.textContent = '제출 완료!';
        setTimeout(() => studentNotice.textContent = '', 2500);
    });

    teacherBtn.addEventListener('click', () => {
        const pw = prompt('교사용 비밀번호를 입력하세요');
        if (pw === TEACHER_PASSWORD) {
            isTeacher = true;
            teacherControls.classList.remove('hidden');
            listTitle.textContent = '교사용 신청 목록';
            teacherBtn.textContent = '교사용 모드 (활성)';
            teacherBtn.classList.add('bg-white/6');
            render();
        } else if (pw !== null) {
            alert('비밀번호가 틀렸습니다.');
        }
    });

    document.getElementById('removeAll').addEventListener('click', () => {
        if (!confirm('모두 삭제하시겠습니까?')) return;
        items = [];
        saveAndRender();
        publish({ type: 'clear' });
    });

    document.getElementById('pinFirst').addEventListener('click', () => {
        if (items.length <= 1) return alert('고정할 항목이 없습니다.');
        const it = items.shift();
        items.push(it);
        saveAndRender();
        publish({ type: 'reorder', payload: items });
    });

    clearLocal.addEventListener('click', () => {
        if (!confirm('로컬 저장된 요청을 초기화할까요?')) return;
        localStorage.removeItem('songRequests');
        items = [];
        render();
    });

    // 초기 실행
    saveAndRender();
    try { setupScaledrone(); } catch (e) { console.warn(e); }
</script>
</body>
</html>
